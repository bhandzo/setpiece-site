---
import PageLayout from "@/layouts/Base.astro";
import { Image } from "astro:assets";
import hills from "@/content/images/hills.jpg";
import { getCollection } from 'astro:content';
import { createReader } from '@keystatic/core/reader';
import keystaticConfig from '../../keystatic.config';

// Get the singleton data
const reader = createReader(process.cwd(), keystaticConfig);
const homepage = await reader.singletons.homepage.read();

// Get collections data
const problemCardsCollection = await getCollection('problemCards') || [];
const differentiatorsCollection = await getCollection('differentiators') || [];
const servicesCollection = await getCollection('services') || [];

// Sort collections by order
problemCardsCollection.sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0));
differentiatorsCollection.sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0));
servicesCollection.sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0));

// Collections are already rendered with Astro v5+
const problemCards = problemCardsCollection;
const differentiators = differentiatorsCollection;
const services = servicesCollection;

// Provide default values if homepage data doesn't exist yet
const content = homepage || {
  heroTitle: 'When you hit a wall, we transform everything.',
  heroDescription: 'We are AI-native operating partners for SaaS leaders who\'ve hit a wall. Get unstuck and go fast (again).',
  mainProblemTitle: 'What got you here stopped working',
  mainProblemDescription: 'Whether you\'re finding product-market fit, scaling past early success, or managing explosive growth - what used to work is now making things worse. Every day feels like trying to stay afloat instead of building the future.',
  differentiatorTitle: 'We\'re Built Different',
  servicesTitle: 'Sprint to get unstuck',
  servicesSubtitle: 'How we work with you to get your groove back',
  servicesDescription: 'Strategy clarity first, then systematic transformation. No wasted effort optimizing the wrong things.',
};
---

<PageLayout meta={{ title: "Home Page" }}>
  <!-- Hero image -->

  <section
    class="gc-full md:col-span-3 md:col-start-4 lg:col-span-5 lg:col-start-5 gr-span-2"
  >
    <h2 class="text-3xl md:text-4xl leading-snug mb-4">
      {content.heroTitle}
    </h2>
    <p class="text-sm leading-normal">
      {content.heroDescription}
    </p>
  </section>
  <section class="gc-full grid-local gr-span-5">
    <div class="gc-full gr-span-4">
      <Image
        src={hills}
        alt="Rolling hills landscape"
        class="w-full h-full object-cover object-top"
      />
    </div>
  </section>

  <!-- Hero statement -->

  <!-- Two-column editorial with asymmetric spans -->
  <section class="gc-full grid-local gr-span-6 border-t-[5px] border-black">
    <section class="gc-full grid-local gr-span-3 border-t-[5px]">
      <article class="col-span-3 md:col-span-5 lg:col-span-5">
        <h3 class="text-3xl md:text-4xl leading-snug mb-4">
          {content.mainProblemTitle}
        </h3>
        <p class="text-sm leading-normal">
          {content.mainProblemDescription}
        </p>
      </article>
    </section>
    {problemCards.map((card) => (
      <section
        class="col-span-1 md:col-span-2 lg:col-span-3 border-t-[5px] border-black p-3"
      >
        <h4 class="text-xl mb-3">{card.data.title}</h4>
        <div class="text-sm leading-normal prose-sm prose-p:mb-0" set:html={card.rendered?.html} />
      </section>
    ))}
  </section>

  <!-- Differentiation -->
  <section class="gc-full grid-local gr-span-4">
    <article class="gc-full md:col-span-2 lg:col-span-2">
      <h3 class="text-3xl md:text-4xl leading-snug mb-4">
        {content.differentiatorTitle}
      </h3>
    </article>
    <div
      class="gc-full grid-local md:col-span-5 md:col-start-3 lg:col-span-6 lg:col-start-4"
    >
      {differentiators.map((diff) => (
        <section class="gc-full border-t-[5px] border-black">
          <h4 class="text-xl mb-3">{diff.data.title}</h4>
          <div class="text-sm leading-normal prose-sm prose-p:mb-0" set:html={diff.rendered?.html} />
        </section>
      ))}
    </div>
  </section>

  <!-- Services -->
  <section class="gc-full grid-local gr-span-8 border-t-[5px] border-black">
    <section class="gc-full grid-local gr-span-2">
      <article
        class="col-span-3 md:col-start-1 md:col-span-5 lg:col-start-1 lg:col-span-7"
      >
        <h3 class="text-3xl md:text-4xl leading-snug mb-4">
          {content.servicesTitle}
        </h3>
        <p class="text-sm leading-normal">
          {content.servicesSubtitle}
        </p>
        <p class="text-sm leading-normal">
          {content.servicesDescription}
        </p>
      </article>
    </section>
    {services.map((service, index) => (
      <section
        class={index === 0 ? "gc-full md:col-span-3 lg:col-span-4 border-t-[5px] border-black" : "col-span-1 md:col-span-3 lg:col-start-6 lg:col-span-4 border-t-[5px] border-black p-3"}
      >
        <h4 class="text-xl mb-3">{service.data.title}</h4>
        <div class="text-sm leading-normal prose-sm" set:html={service.rendered?.html} />
      </section>
    ))}
  </section>
</PageLayout>

<!-- Three-column problem sections -->