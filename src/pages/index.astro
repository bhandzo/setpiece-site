---
import PageLayout from "@/layouts/Base.astro";
import { Image } from "astro:assets";
import hills from "@/content/images/hills.jpg";
import { getCollection } from "astro:content";

// Import homepage data directly - Astro handles YAML natively
import homepage from "@/content/homepage/index.yaml";

// Get collections data
const problemCardsCollection = (await getCollection("problemCards")) || [];
const differentiatorsCollection =
  (await getCollection("differentiators")) || [];
const servicesCollection = (await getCollection("services")) || [];

// Sort collections by order
problemCardsCollection.sort(
  (a, b) => (a.data.order ?? 0) - (b.data.order ?? 0)
);
differentiatorsCollection.sort(
  (a, b) => (a.data.order ?? 0) - (b.data.order ?? 0)
);
servicesCollection.sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0));

// Collections are already rendered with Astro v5+
const problemCards = problemCardsCollection;
const differentiators = differentiatorsCollection;
const services = servicesCollection;

// Use the homepage data and fail loudly if it doesn't exist
if (!homepage) {
  throw new Error("Homepage data not found at src/content/homepage/index.yaml");
}

const content = homepage;
---

<PageLayout meta={{ title: "Home Page" }}>
  <!-- Hero image -->

  <section class="gc-full md:col-span-5 lg:col-span-8 gr-span-2">
    <h2 class="text-3xl md:text-4xl leading-snug mb-4">
      {content.heroTitle}
    </h2>
    <p class="text-sm leading-normal">
      {content.heroDescription}
    </p>
  </section>
  <section class="gc-full grid-local gr-span-5">
    <div class="gc-full gr-span-5">
      <Image
        src={hills}
        alt="Rolling hills landscape"
        class="w-full h-full object-cover object-top"
      />
    </div>
  </section>

  <!-- Hero statement -->

  <!-- Two-column editorial with asymmetric spans -->
  <section class="gc-full grid-local gr-span-6">
    <section class="gc-full grid-local gr-span-2">
      <article class="col-span-3 md:col-span-5 lg:col-span-5">
        <h3 class="text-3xl md:text-4xl leading-snug">
          {content.mainProblemTitle}
        </h3>
        <p class="text-sm leading-normal">
          {content.mainProblemDescription}
        </p>
      </article>
    </section>
    {
      problemCards.map((card) => (
        <section class="col-span-3 md:col-span-2 lg:col-span-3 md:border-t-[5px] md:border-black">
          <h4 class="text-xl">{card.data.title}</h4>
          <div
            class="text-sm leading-normal prose-sm prose-p:mb-0"
            set:html={card.rendered?.html}
          />
        </section>
      ))
    }
  </section>

  <!-- Differentiation -->
  <section class="gc-full grid-local gr-span-5">
    <article class="gc-full md:col-span-2 lg:col-span-2">
      <h3 class="text-3xl md:text-4xl leading-snug mb-4">
        {content.differentiatorTitle}
      </h3>
    </article>
    <div
      class="gc-full grid-local md:col-span-5 md:col-start-3 lg:col-span-6 lg:col-start-4"
    >
      {
        differentiators.map((diff) => (
          <section class="gc-full border-t-[5px] border-black">
            <h4 class="text-xl mb-3">{diff.data.title}</h4>
            <div
              class="text-sm leading-normal prose-sm prose-p:mb-0"
              set:html={diff.rendered?.html}
            />
          </section>
        ))
      }
    </div>
  </section>

  <!-- Services -->
  <section class="gc-full grid-local gr-span-10 border-t-[5px] border-black">
    <section class="gc-full grid-local gr-span-2">
      <article
        class="col-span-3 md:col-start-1 md:col-span-5 lg:col-start-1 lg:col-span-7"
      >
        <h3 class="text-3xl md:text-4xl leading-snug mb-4">
          {content.servicesTitle}
        </h3>
        <p class="text-sm leading-normal">
          {content.servicesSubtitle}
        </p>
        <details class="group">
          <summary class="text-sm leading-normal cursor-pointer list-none">
            <span class="group-open:hidden">{content.servicesDescription}</span>
            <span class="hidden group-open:inline"
              >Click to collapse description</span
            >
          </summary>
          <div class="text-sm leading-normal mt-2">
            <p>
              This is additional content that expands when you click the summary
              above. You can put any server-rendered content here - paragraphs,
              lists, or even more complex markup.
            </p>
            <p>
              Since this is server-rendered, it works perfectly with Astro's
              static generation and doesn't require any JavaScript.
            </p>
          </div>
        </details>
      </article>
    </section>
    <div class="gc-full grid-local gr-span-4">
      {
        services.map((service, index) => (
          <section class="col-span-3 md:col-span-3 lg:col-span-4 border-t-[5px] border-black p-3">
            <h4 class="text-xl mb-3">{service.data.title}</h4>
            <div
              class="text-sm leading-normal prose-sm"
              set:html={service.rendered?.html}
            />
          </section>
        ))
      }
    </div>
  </section>
</PageLayout>

<!-- Three-column problem sections -->
